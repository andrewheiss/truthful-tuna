---
title: "Descriptive stuff"
format:
  html:
    code-fold: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,
                      fig.width = 6, fig.height = (6 * 0.618),
                      out.width = "80%", collapse = TRUE,
                      dev = "ragg_png")

options(digits = 3, width = 120,
        dplyr.summarise.inform = FALSE,
        knitr.kable.NA = "")
```

```{r load-libraries-data, warning=FALSE, message=FALSE}
library(tidyverse)
library(targets)
library(sf)
library(countrycode)
library(scales)
library(gt)
library(here)

tar_config_set(store = here('_targets'),
               script = here('_targets.R'))

tar_load(c(survey_orgs, survey_countries))
tar_load(c(world_map))

# Plotting functions
invisible(list2env(tar_read(graphic_functions), .GlobalEnv))
```

# General respondent details

## How many NGOs responded?

```{r summary-n-respondents}
#| code-fold: show
nrow(survey_orgs)
```

## How many respondents answered questions for more than one country?

```{r summary-n-multiple-countries}
#| code-fold: show
survey_countries %>% 
  summarize(more_than_1 = sum(loop.number > 1),
            prop = more_than_1 / nrow(survey_orgs))
```

## Who in the organization responded to the survey?

```{r plot-respondents-who, fig.width=6, fig.height=3}
df_plot_respondents <- survey_orgs %>%
  group_by(Q2.3) %>%
  summarise(num = n()) %>%
  arrange(num) %>% 
  mutate(question = fct_inorder(Q2.3)) 

df_plot_respondents %>% 
  ggplot(aes(x = num, y = question)) +
  geom_col() +
  scale_x_continuous(expand = c(0, 0),
                     sec.axis = sec_axis(~ . / sum(df_plot_respondents$num),
                                         labels = label_percent())) +
  labs(x = "Respondents", y = NULL,
       title = "Who filled out the survey?",
       subtitle = "Q2.3: What is your position in your organization?") +
  theme_ingo()
```

Lots of others. Who are the others?

```{r tab-who-responded-others}
survey_orgs %>%
  filter(!is.na(Q2.3_TEXT)) %>%
  mutate(`Position in organization` = str_to_title(Q2.3_TEXT)) %>%
  group_by(`Position in organization`) %>%
  summarise(Count = n()) %>%
  mutate(Proportion = Count / sum(Count)) %>%
  arrange(desc(Count)) %>% 
  gt() %>% 
  fmt_percent(columns = Proportion, decimals = 1) %>% 
  opt_interactive(use_compact_mode = TRUE, use_highlight = TRUE) %>% 
  opt_table_font(font = "Fira Sans")
```


# Where are NGOs based?

## How are these NGOs distributed by HQ?

```{r tab-hq-countries}
df_hq_countries <- survey_orgs %>% 
  group_by(Q2.2_iso3) %>% 
  summarize(num_ngos = n()) %>% 
  mutate(num_ngos_ceiling = ifelse(num_ngos >= 30, 30, num_ngos),
         ngo_presence = ifelse(num_ngos >= 1, "At least one NGO respondent", NA),
         prop = num_ngos / sum(num_ngos)) %>% 
  mutate(country_name = countrycode(Q2.2_iso3, "iso3c", "country.name")) %>%
  arrange(desc(num_ngos))

df_hq_countries %>% 
  select(country_name, Q2.2_iso3, num_ngos, prop) %>%
  gt() %>% 
  cols_label(
    country_name = "Country name",
    Q2.2_iso3 = "ISO3",
    num_ngos = "NGOs",
    prop = "Proportion"
  ) %>% 
  fmt_percent(columns = prop, decimals = 1) %>% 
  opt_interactive(use_compact_mode = TRUE, use_highlight = TRUE) %>% 
  opt_table_font(font = "Fira Sans")
```

## Number of unique HQ countries

```{r}
#| code-fold: show
df_hq_countries %>% 
  summarize(total = sum(num_ngos >= 1))
```

## Regional distribution of HQ countries

```{r tab-hq-regions}
df_hq_regions <- df_hq_countries %>%
  mutate(region = countrycode(Q2.2_iso3, "iso3c", "continent"),
         region = ifelse(Q2.2_iso3 == "TWN", "Asia", region)) %>%
  mutate(region = recode(region, Oceania = "Asia &\nOceania", Asia = "Asia &\nOceania")) %>%
  group_by(region) %>%
  summarise(num = sum(num_ngos)) %>% ungroup() %>%
  mutate(prop = num / sum(num)) %>%
  arrange(desc(num)) %>%
  mutate(region = fct_rev(fct_inorder(region)))

df_hq_regions %>% 
  gt() %>% 
  cols_label(
    region = "Region",
    num = "NGOs",
    prop = "Proportion"
  ) %>% 
  fmt_percent(columns = prop, decimals = 1) %>% 
  cols_align(align = "left", columns = region) %>% 
  opt_interactive(use_compact_mode = TRUE, use_highlight = TRUE, 
                  use_pagination = FALSE, use_pagination_info = FALSE) %>% 
  opt_table_font(font = "Fira Sans")
```

```{r plot-hq-regions, fig.width=6, fig.height=3}
ggplot(df_hq_regions, aes(x = num, y = region)) +
  geom_pointrange(aes(xmin = 0, xmax = num)) +
  scale_x_continuous(sec.axis = sec_axis(~ . / sum(df_hq_regions$num),
                                         labels = label_percent())) +
  labs(x = "Respondents based in region", y = NULL,
       title = "Region of headquarters",
       subtitle = "Q2.2: Where is your organization's headquarters? (summarized by region)") +
  theme_ingo() + 
  theme(panel.grid.major.y = element_blank())
```

## Responses per country (30 NGO ceiling)

```{r plot-map-respondents-gradient}
map_hq <- world_map %>% 
  left_join(df_hq_countries, by = join_by(ISO_A3 == Q2.2_iso3))

ggplot() +
  geom_sf(data = map_hq, aes(fill = num_ngos_ceiling),
          linewidth = 0.1, color = "grey30") +
  scale_fill_binned(low = clrs$Peach[1], high = clrs$Peach[7], na.value = "grey95",
                    labels = c(1, 10, 20, "30+"), breaks = c(1, 10, 20, 30),
                    name = "Number of NGOs: ",
                    guide = guide_colorsteps(barwidth = 7, barheight = 0.4,
                                             title.vjust = 1)) +
  coord_sf(crs = "+proj=robin") +
  theme_ingo_map()
```

## Countries with at least one response

```{r plot-map-respondents-binary}
ggplot() +
  geom_sf(data = map_hq, aes(fill = ngo_presence),
          linewidth = 0.1, color = "grey30") +
  scale_fill_manual(values = c(clrs$Peach[7], "grey95"), 
                    na.value = "grey95", na.translate = FALSE,
                    name = NULL) +
  coord_sf(crs = "+proj=robin") +
  theme_ingo_map()
```


# Where do NGOs work?



# What do these NGOs do?






